jump=[0  0  0  0  0  0  0  0  0  0  0  0  0  0 -1 0 -1  1   0  0;
     0  0  0  0 -1  0 -1  0  0  0  0  0  0  0  0  0  0  0  1  0;
     0  0  0  0  0  0  0  0 -1  0 -1  0  0  0  0  0  0  0  1  0;
     0  0  0  0  0  0  0  0  0  0  0  0 -1  0  0  0  0 -1  1  0;
    -1  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0 -1  1;
     1  0  0  0  1  0  1  0  0  0  0  0  0  0  0  0  0  0  0 -1;
     1  0  0  0  0  0  0  0  1  0  1  0  0  0  0  0  0  0  0 -1;
     1  0  0  0  0  0  0  0  0  0  0  0  1  0  1  0  1  0  0 -1];
 
 T=@(X,MU,NC) [min(X(17),NC(3))*MU(17);
            div(X(7),X(7)+X(11)+X(18))*min(X(7)+X(11)+X(18),NC(2))*MU(7);
            div(X(11),X(7)+X(11)+X(18))*min(X(7)+X(11)+X(18),NC(2))*MU(11);
            div(X(18),X(7)+X(11)+X(18))*min(X(7)+X(11)+X(18),NC(2))*MU(18);
            min(X(19),NC(1))*MU(19);
            X(20)*(1.0/3)*MU(20);
            X(20)*(1.0/3)*MU(20);
            X(20)*(1.0/3)*MU(20);];
        
MU=[-1.0  -1.0  -1.0  -1.0  -1.0  -1.0  1000  -1.0  -1.0  -1.0  1000  -1.0  -1.0  -1.0  -1.0  -1.0  1000  1000  1000  1];
NC=[2,2,2];

X0=zeros(1,20);
X0(end)=1500;
dt=10^-3;
rep=1;

Xi=zeros(50000,size(X0,2));
Xi(1,:)=X0;
for i=1:size(Xi,1)

    k1=dt*jump'*T(Xi(i,:),MU,NC);
    k2=dt*(jump'*T(Xi(i,:),MU,NC))+k1/2;
    k3=dt*(jump'*T(Xi(i,:),MU,NC))+k2/2;
    k4=dt*(jump'*T(Xi(i,:),MU,NC))+k3;

   Xi(i+1,:)=1/6*(k1+2*k2+2*k3+k4)+Xi(i,:)';
   %Xi(i+1,:)=k1+Xi(i,:)';
end

Xsim = mean(lqn(X0,MU,[inf,inf,inf,inf],[inf,NC],dt*size(Xi,1),rep,dt),3);

figure 
hold on
plot(Xsim(end,:))
plot(Xi(:,end))